\chapter{Технологический раздел}

В данном разделе будут рассмотрены особенности реализации программного обеспечения (ПО),
разработанного в конструкторской части работы, и приведены примеры работы программы.

\section{Требования к программному обеспечению}

Программа должна предоставлять следующий функционал:
\begin{itemize}
    \item получение изображения сцены с учетом материалов объектов сцены и освещения;
    \item интерактивное управление камерой;
    \item время отрисовки одного кадра не больше 100мс;
    \item симуляция распространения воксельных частиц воды.
\end{itemize}

Программа должна корректно и оперативно реагировать на все действия пользователя.

\section{Средства реализации}

В качестве графического API для реализации разработанного ПО 
был выбран WebGPU~\cite{WebGPU} -- современный переносимый графический
API.
Он может быть использованным при разработке на любой из платформ, 
поддерживающих популярные API: Direct3D~\cite{DirectX12}, 
Metal~\cite{Metal}, Vulkan~\cite{Vulkan}, OpenGLES~\cite{OpenGLES}, WebGL~\cite{WebGL} и другие.

В качестве языка программирования для реализации ПО был выбран Rust -- 
статически типизированный компилируемый язык программирования общего назначения~\cite{Rust}.
Данный выбор обусловлен наличием возможностей 
компиляции на множественное число платформ, в том числе на WASM~\cite{WASM}, наличием
библиотек с поддержкой WebGPU, линейной алгебры.

Для реализации графического интерфейса была выбрана библиотека Dear ImGui~\cite{ImGui}.
Она реализует графический интерфейс в режиме IMGUI (англ. immediate mode GUI). Библиотека написана 
для использования с любым графическим API и представляет способ динамического 
программирования интерфейсов.

ПО реализовано для платформы WASM и нативных MacOS, Linux, Windows. 
Алгоритм отриасовки реализован в вершинном и фрагментном шейдерах на языке WGSL~\cite{WebGPUSL}.

\section{Реализации алгоритмов}

\subsection{Реализация алгоритма быстрого обхода вокселей для трассировки лучей}

В листинге~\ref{lst:voxel.wgsl} приведена реализация алгоритма быстрого 
обхода вокселей для трассировки лучей.

\pagebreak

\includelisting
    {voxel.wgsl}
    {Реализация алгоритма быстрого обхода вокселей для трассировки лучей}

\subsection{Реализация алгоритма трассировки лучей}

В листинге~\ref{lst:trace.wgsl} приведена реализация алгоритма трассировки лучей.
Функция \verb|scatter| выполяет расчет цвета и направления отражения луча.

\includelisting
    {trace.wgsl}
    {Реализация алгоритма трассировки лучей}

\subsection{Реализация алгоритма кеширования обратной репроекции}

В листинге~\ref{lst:cache.wgsl} приведена реализация алгоритма кеширования обратной репроекции.

\includelisting
    {cache.wgsl}
    {Реализация алгоритма кеширования обратной репроекции}

Каждый кадр использует 4 буфера, содержащих следующую информацию о каждом пикселе:
\begin{itemize}
    \item цвет,
    \item вектор нормали,
    \item координаты первого столкновения луча при трассировке,
    \item идентификатор материала.
\end{itemize}

В ходе отрисовки каждого кадра имеется доступ к буферам прошлого кадра,
что позволяет выполнять обратную репроекцию.

\section{Реализация материала воды}

В листинге~\ref{lst:water} приведена реализация материала водыы. Также в программе реализованы
материалы матовой поверхности и поверхности метала аналогично тем, что описаны в~\cite{RTW}.
Функция \verb|schlick| выполняет аппроксимацию Шлика коэффициента вклада фактора Френеля в 
зеркальное отражение.

\begin{lstlisting}[caption={Реализация материала воды},label={lst:water},frame=single]
var refraction_ratio = material.refractive_index;
let rn = dot(ray.direction, hrec.normal);
if rn <= 0.0 {
    refraction_ratio = 1.0 / refraction_ratio;
}
let cos_theta = min(-rn, 1.0);
let sin_theta = sqrt(1.0 - cos_theta * cos_theta);

if refraction_ratio * sin_theta > 1.0 || 
   schlick(cos_theta, refraction_ratio) > random_f32() {
    srec.direction = reflect(ray.direction, hrec.normal);
    srec.attenuation = vec3f(1.0);
} else {
    srec.direction = refract(ray.direction, hrec.normal, 
                             refraction_ratio);
    srec.attenuation = material.albedo;
}
\end{lstlisting}

\section{Дополнительные алгоритмы}

При реализации программы также были реализованны дополнительные алгоритмы, рассмотрение 
которых выходит за рамки данной работы. Список алгоритмов и их назначения:
\begin{itemize}
    \item \verb|xorshift32|~\cite{xorshift} -- алгоритм генерации случайных чисел, используемый в шейдерах;
    \item шум Перлина~\cite{perlin} -- используется для генерации ландшафта;
    \item размытие по Гауссу -- используется для уменьше количества шума на изображении;
    \item алгоритм симуляции распространения воды.
\end{itemize}

\section{Описание интерфейса программы}

На рисунке~\ref{img:interface} представлен интерфейс реализоавнной программы.

\includeimage
    {interface}
    {f}
    {H}
    {0.90\textwidth}
    {Интерфейс реализованной программы}

Интерфейс программы реализован в виде двух плавающих окон внутри окна приложения.
В окне <<Справка>> указаны параметры управления, использующие клавиатуру и мышь.
В окне <<Настройки>> приведены параметры сцены и отображения с возможностью их изменения.

Программа позволяет изменять следующие параметры сцены и ее отображения:
\begin{itemize}
    \item параметры симуляции воды;
    \item параметр алгоритма трассировки -- максимальное число отскоков луча;
    \item параметр алгоритма проверки столкновений -- максимальнаядальность видимости;
    \item перемещения камеры и ее поворот, выраженный в углах рысканья и тангажа;
    \item параметры воды -- коэффицент преломления света и цвет.
\end{itemize}

\section{Примеры работы программы}

На рисунке~\ref{img:ex1} приведен пример работы программы, показывающий отрисованную 
сцену ландшафта. Можно заметить изменение цвета поверхности воды в зависимости
от угла наблюдения и наличие отражений.

\includeimage
    {ex1}
    {f}
    {H}
    {0.90\textwidth}
    {Пример 1}

На рисунке~\ref{img:ex2} приведен пример работы программы, показывающий отрисованную сцену ландшафта
с водопадом. Можно заметить наличие как преломления света, так и отражения света 
в изображениях столба воды и ее поверхности соответственно.

\includeimage
    {ex2}
    {f}
    {H}
    {0.90\textwidth}
    {Пример 2}

\section*{Вывод}

В данном разделе были описаны детали реализации разработанной программы. 
Также был рассмотрен процесс взаимодействия пользователя с программой.
Были приведены примеры использования программы.
