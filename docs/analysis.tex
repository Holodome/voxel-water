\chapter{Аналитический раздел}

В данном разделе будут рассмотрены возможножсти отрисовки 
трехмерных изображений в реальном времени, проанализированы особенности трехмерной 
воксельной графики; будет выбран метод решения поставленной задачи.

\section{Выбор оборудования}

Построение трехмерных изображений -- вычислительно сложная, и в то же время, чрезвычайно 
параллельная задача~\cite{DaBPP}. Такие особенности стали причиной появляния специального оборудования 
для выполнения популярных задач компьютерной графики. Такие вычислительные устройства
называются Графическими процессорами (GPU), хотя их применение не ограничивается вычислениями
графических данных. Появление таких устройств вызвано ограничениями в дизайне центральных
процессоров. Они используются для последовательного выполнения кода с большим числом условных 
переходов, на небольшом числе ядер при SMP. И несмотря на 
развитие SIMD парадигмы, позволяющей обрабатывать большее число данных, чем позволяет
последовательное исполнения, ЦПУ не смогли стать универсальными устройствами для рендеринга.
Особенностью графических сопроцессоров ялвяется большое число ядер, способных эффективно 
выполнять тысячи вычислений параллельно~\cite{ACLaG}.

Несмотря на большие возможности параллельного выполнения вычислительных задач,
графические сопроцессоры имеют органиченные возможности условного выполнения программ, в 
частности, рекурсивных, малую скорость памяти, и возможности взаимодействия с ней.

Такие особенности породили целый ряд алгоритмов, оптимизированных для выполняения 
на графических
сопроцессорах, которые отличаются от аналогичных для процессоров общего назначения. 
В частности, 
графические сопроцессоры могут иметь специальные аппаратные блоки для ускоренного выполнения 
алгоритмов трассировки лучей, и все из них имеют аппартное ускорение алгоритма Z-буфера~\cite{RTiv}.

Из-за развития графических сопроцессоров, использование ЦПУ для реализации графических
вычислений устарело. Графические сопроцессоры предоставляют более широкие возможности 
для проведения операций, типичных для компьютерной графики. 

\section{Выбор алгоритма отрисовки}

При выборе алгоритма отрисовки должны быть учтены особенности поставленной задачи.
Отрисовка будет выполняться в режиме реального времени. Этот факт 
предъявляет к алгоритму требование по скорости работы, время отрисовки кадра не должно занимать
больше небольшого количества миллисекунд. Также для визуализации воды следует построить
некоторые физические эффекты: отражение и преломление света. Выбираемый алгоритм отрисовки
должен поддерживать визуализацию или приближение физических явлений.

Будут рассмотрены алгоритмы, эффекивная реализация которых может быть получена при использовании
графических ускорителей. 

\subsection{Алгоритм, использующий Z-буфер}
Z-буфер, или буфер глубины, является одним из простейших алгоритмов отрисовки.
Z-буфер -- это простое расширение идеи буфера кадра. Буфер кадра используется 
для хранения атрибутов (интенсивности или оттенка) каждого пикселя в пространстве изображения. 
Z-буфер является отдельным буфером глубины, используемым для хранения координат или глубины 
каждого видимого пикселя в пространстве изображения. При использовании глубина или значение $z$ нового пикселя, 
который записывается в буфер кадра, сравнивается с глубиной этого пикселя, хранящейся в z-буфере. 
Если сравнение показывает, что новый пиксель находится перед пикселем, хранящимся в буфере кадра, 
то новый пиксель записывается в буфер кадра, а $z$-буфер обновляется новым значением $z$. 
В противном случае никаких действий не предпринимается. Концептуально алгоритм является поиском 
по $x$, $y$ для нахождения наибольшего значения $z(x, y)$.

Простота алгоритма -- его главное преимущество. Кроме того, он легко справляется с проблемой видимой 
поверхности и отображением сложных пересечений поверхностей. Хотя алгоритм $z$-буфера часто 
реализуется для многогранно представленных сцен, он применим для любого объекта, для 
которого можно рассчитать глубину и характеристики тени~\cite{Rodzhers}.

Аппартные графические ускорители изначально были спроектированы для использования в мультимедийных
приложениях, использующих алгоритм $z$-буффера. В силу этого почти все их конвееры заточены
специально под эффективную реализацию этого алгоритма с некоторыми расширениями. Таким образом,
использование алгоритма $z$-буффера при отрисовке на графических ускорителях обеспечивает
хорошую производительность.

Однако, алгоритм $z$-буффера плохо подходит для реализации физически-корректного рендеринга.
В частности, симуляция отражения или преломления требует множественной отрисовки сцены
из разных точек, что замедляет общий процесс отрисовки. Дополнительно, получаемые при отрисовке
результаты оказываются менее физически точными, чем при использовании алгоритма трассировки лучей. 
В силу этого, в последние годы традиционные конвееры отрисовки на графических ускорителях 
расширяются добавлением трассировки лучей для получения лучшего качества изображения\cite{FoCG}.

Характеристики алгоритма:
\begin{itemize}[label*=---]
    \item Поддержка физически-корректной отрисовки требует больших модификаций алгоритма,
        дополнительных затрат памяти и времени;
    \item Отличная аппаратная поддержка;
    \item Малые вычислительные затраты за счет аппаратной поддержки.
\end{itemize}

\subsection{Трассировка лучей}
Почти все системы фотореалистичной рендеринга основаны на алгоритме трассировки лучей. 
Трассировка лучей на деле очень простой алгоритм; он основан на отслеживании пути луча света 
через сцену, по мере его взаимодействия и отражения от объектов в окружающей среде.
Несмотря на то, что существует множество способов реализовать алгоритм трассировки лучей, 
все такие системы должны включать в себя и симулировать следующие объекты и феномены:

\begin{itemize}[label*=---]
    \item Камеры: Модель камеры определяет, как и откуда просматривается сцена, включая то, как 
        изображение сцены записывается на сенсоре. Многие системы рендеринга генерируют оптические 
        лучи, начинающиеся в камере, которые затем прослеживаются в сцене.

    \item Пересечение лучей и объектов: Нам необходимо точно определить, где заданный луч пересекает 
        заданный геометрический объект. Кроме того, нам нужно определить некоторые свойства объекта 
        в точке пересечения, такие как нормаль поверхности или его материал. Большинство 
        трассировщиков лучей также имеют некоторую возможность проверки пересечения луча с 
        несколькими объектами, обычно возвращают ближайшее пересечение по лучу.

    \item Источники света: Без освещения бессмысленно визуализировать сцену. Трассировщик лучей 
        должен моделировать распределение света по всей сцене, включая не только местоположение 
        самих источников света, но и способ, которым они распространяют свою энергию в пространстве.

    \item Видимость: Чтобы знать, может ли заданный источник света передавать энергию в точку 
        поверхности, нам нужно знать, есть ли непрерывный путь от точки до источника света. 
        К счастью, на этот вопрос легко ответить в трассировщике лучей, так как мы просто 
        можем построить луч от поверхности до источника света, найти ближайшее пересечение луча
        с объектом и сравнить расстояние пересечения с расстоянием до источника света.

    \item Рассеяние на поверхности: Каждый объект должен предоставить описание своего вида, 
        включая информацию о том, как свет взаимодействует с поверхностью объекта, а также о
        характере перераспределенного (или рассеянного) света. Модели рассеивания на поверхности 
        обычно параметризуются таким образом, чтобы можно было смоделировать разнообразные внешние виды.

    \item Непрямое распространение света: Поскольку свет может достигать поверхности после отражения 
        от других поверхностей или прохождения через них, обычно необходимо проследить дополнительные 
        лучи, исходящие из поверхности, чтобы полностью учесть этот эффект.

    \item Распространение лучей: Нам нужно знать, что происходит с светом, распространяющимся вдоль 
        луча по мере его прохождения через пространство. Если мы отображаем сцену в вакууме, 
        энергия света остается постоянной вдоль луча. Хотя истинные вакуумы необычны на Земле, 
        для многих сред они являются разумным приближением. Для отслеживания лучей через туман, 
        дым, атмосферу Земли и т. д. доступны более сложные модели~\cite{PBRT3e}.
\end{itemize}

Трассировка лучей, являясь крайне простым алгоритмом, предоставляет несчислимые возможности для 
расширения. Алгоритм трассировки лучей может использоваться для создания фотореалистичных
изображений~\cite{PBRT3e}. Такие трассировщики используются при создании спецэффектов к фильмам, 
анимационных картин и др. 

Характеристики алгоритма:
\begin{itemize}[label*=---]
    \item Поддержка физически-корректной отрисовки не требует больших модификаций алгоритма,
        дополнительных затрат памяти;
    \item Физически-корректная отрисовка работает для большинства физических эффектов,
        исключая некоторые специфичные (к примеру, каустики);
    \item Слабая аппаратная поддержка (только некоторые новые графические ускорители, и только 
        некоторые графические API);
    \item Большие вычислительные затраты.
\end{itemize}

\section{Выбор алгоритма обхода воксельной сцены}

Воксель -- способ представления геометрии, альтернативный типичному
полигональному. Воксель представляет собой некоторое значение на регулярной решетке в 
трехмерном пространстве. Воксели часто испольуются при анализе медицинских и научных
данных.

В интерактиных графических приложениях, выполняющих отрисовку в реальном времени, воксели 
редко применялись в качестве основного геометрического примитива. Это связано с тем, что
графические сопроцессоры были специально оптимизированы для работы с полигоныльными данными,
и они были более простым способом достичь требуемого качества изображения. 

В последние годы замечается тенденция повышения популярности вокселей в интерактивных приложениях.
Это связано с повышением мощности вычислительной техники, позволяющей выполнять ранее невозможные
вычисления на пользовательских компьютерах. Воксельная графика позволяет достигать большей детализации,
чем возможно при использовании полигонов. 

Главная проблема воксельной графики -- большое число затрачиваемой памяти и медленный доступ к ней.
Поэтому все воксельные алгоритмы фокусируются на ускорении доступа к индивидуальным вокселям, для
использования в алгоритмах отрисовки. Рассмотрим и выберем алгоритм обхода воксельной сцены и 
структуру данных хранения вокселей.

\subsection{Алгоритм быстрого обхода вокселей для трассировки лучей}
Рассматриваемый алгоритм описан в классической статье задолго до массового распространения 
графических ускорителей и повсеместного использования трассировки лучей. В ней формализован и описан несложный алгоритм обхода воксельной трехмерной сетки с константным масштабом (см.~рисунок~\ref{img:fvta}).

Переход от одного вокселя к его соседу требует только двух сравнений чисел с плавающей запятой  
одного сложения чисел с плавающей запятой. Кроме того, исключаются множественные пересечения лучей с объектами, находящимися в более чем одном вокселе
~\cite{AFVTAfRT}.

\includeimage
    {fvta}
    {f}
    {!ht}
    {0.80\textwidth}
    {Алгоритм быстрого обхода вокселей для трассировки лучей}

Авторами отмечается один существенный недостаток: высокие вычислительные затраты. Для решения
этой пробремы они предлагают вводить оптимизационные структуры, к примеру, BVH. Такие структуры должны разделять пространство мира
и проверять луч на столкновение только с его частью, вместо всего пространства. Проблема такого 
подхода заключается в том, что BVH требует больших вычислительных затрат на построение, и
само построение -- NP-полная задача. Это делает рассматриваемый алгоритм малоприменимым во 
всех нетривиальных случаях.

\subsection{k-d дерево}

k-d дерево (сокращение от k-мерного дерева) - это структура данных 
для разделения пространства, предназначенная для организации точек в 
k-мерном пространстве. k-d деревья являются полезной структурой данных 
для нескольких приложений, таких как поиск с использованием многомерного 
ключа поиска (например, поиск по диапазону и поиск ближайшего соседа) и 
создание облаков точек. k-d деревья являются особым случаем деревьев 
бинарного разделения пространства. k-d дерево -- это бинарное дерево, где каждая 
вершина -- это точка в k-мерном пространстве. Каждая вершина, не являющаяся листом 
может быть представлена как неявная гиперплоскость, разделяящая простраство на две части.
Точки в каждой из частей представлены соответсвующии поддеревьями (см.~пример~на
рисунке~\ref{img:kd}).

\includeimage
    {kd}
    {f}
    {!ht}
    {0.80\textwidth}
    {Пример двумерного k-d дерева}

k-d дерево стало популярным как основная оптимизационная структура в 
трассировщиках лучей. Были предложены алгоритмы оптимизации структуры для графических
ускорителей. Результаты замеров показывают, что скорость отрисовки сцены с использованием
k-d дерева как минимум на порядок больше, чем скорость отрисовки в сетке с константным 
размером сетки.

k-d дерево можно использовать для отрисовки сцен с геометрией, хранимой в произвольном 
формате. Вариант k-d дерева, используемый при воксельной отрисовке -- Октодерево. Это k-d дерево в трехмерном пространстве, где у каждой родительской вершины 8 детей~\cite{KDTASfaGR}.

\subsection{Разреженное воксельное октодерево}

Проблема обычного Октодерева -- это то, что оно хранит данные для каждого из элементов 
пространства. Обычно сцены являются разреженными, что делает плотное хранение данных
избыточным по памяти, и менее производительным. Поэтому чаще всего при отрисоввке
воксельных сцен в качестве оптимизационной структуры данных применяется разреженное воксельное
октодерево (см.~рисунок~\ref{img:octree}).

\includeimage
    {octree}
    {f}
    {!ht}
    {0.80\textwidth}
    {Октодерево}

Такая структура данных имеет как отличные временные характеристики, так и малые затраты памяти.
Основная сложность заключается в организации данных в оперативной памяти, на диске, 
и в памяти графического ускорителя~\cite{ESVOAEaI}.

\section{Выбор модели освещения}

Модель освещения в случае трассировки лучей -- это фундаментальная характеристика программы-отрисовщика. Это связано с тем, что трассировка лучей полагается на выбранную модель освещения
при построении изображения, и от выбранной модели зависят не только детали картинки, как в случае с $z$-буффером, но качества результата в целом.

\subsection{Модель освещения Ламберта}
Самая простая модель затенения основана на наблюдении, сделанном Ламбертом в 18 веке: 
количество энергии от источника света, которое падает на поверхность, зависит от угла 
поверхности к свету. Поверхность, направленная прямо на свет, получает максимальное 
освещение; поверхность, касательная к направлению света (или обращенная к свету), 
не получает освещение; и между ними освещение пропорционально косинусу угла $\theta$
между нормалью поверхности $n$ и источником света $l$. Это приводит к 
модели освещения Ламберта:

\begin{equation}
L = k_d I max(0, n \cdot l)
\end{equation}

где $I$ -- интенсивность источника света. Поскольку $n$ и $l$ -- единичные векторы, мы можем использовать $n \cdot l$ как удобное сокращение для $cos(\theta)$. 
Вектор $l$ вычисляется путем вычитания точки пересечения луча и поверхности из положения 
источника света~\cite{FoCG}.

\subsection{Модель освещения Фонга}
Модель освещения Ламберта не зависит от точки обзора: цвет поверхности не 
зависит от направления, с которого на нее смотреть. Многие реальные поверхности 
обладают определенной степенью блеска, создающего мерцание или зеркальные отражения, 
которые кажутся перемещающимися при изменении точки обзора. 
Ламбертово освещение не создает мерцания и создает очень матовый, 
меловидный вид, и множество моделей освещения добавляют зеркальную 
составляющую к ламбертовому освещению; ламбертова часть в таком случае 
является диффузной составляющей. 

Очень простая и широко используемая модель для зеркальных мерцаний была 
предложена Фонгом, а позже обновлена Блинном до 
формы, которая наиболее распространена сегодня. Идея заключается в создании 
отражения, которое ярче всего, когда векторы v и l симметрично расположены 
относительно нормали поверхности, то есть, когда происходит зеркальное 
отражение; отражение затем постепенно уменьшается, по мере того, 
как векторы отдаляются от зеркальной конфигурации. Таким образом, формула модели
освещения Фонга:

\begin{equation}
    h = \frac{v + 1}{||v+1||},
\end{equation}
\begin{equation}
    L = k_d I max(0, n \cdot l) + k_s I max(0, n \cdot  h)^2
\end{equation}

где $h$ -- бисскетриса угла между $v$ и $l$; $p$ -- экспонента Фонга; $k_s$ -- коэффицент зеркальности~\cite{IFCGP}~\cite{FoCG}.

\subsection{Физически-корректная модель}

Модели Ламберта и Фонга просты, и поэтому их использование не требует больших вычислительных
затрат. Но в то же время, они лишь пытаются построить упрощенную модель освещения пространства, в то время как может быть построена более общая симуляция физических явлений.

Подход, в котором для построение изображений используется симуляция физических 
явлений, а не ее приближение, называется физически-корректной моделью освещения.
Реализация алгоритмов такого подхода построена на Методе Монте-Карло. Производится
отрисовка сцены с множеством переменных параметров, к примеру, направлению лучей,
или распределению света по пространству, которые имеют заранее известные 
характеристики вероятностного распределения.

Задача построения изображения в физически-корректной модели -- задача 
интеграции Уравнения рендеринга~\cite{EoR}. Для интеграции используется
статистический анализ распределения значений Двулучевой функции отражательной 
способности~\cite{PBRT3e}.

\paragraph{Микрогранные модели}""\\
Многие подходы к моделированию отражения и пропускания поверхности, основанные 
на геометрической оптике, основаны на идее того, что шероховатые поверхности 
могут быть представлены в виде набора маленьких граней. Микрограни часто моделируются 
в виде поверхностей с высотой, где распределение ориентации граней описывается статистически.

\begin{figure}[!ht]
  \centering
  \includesvg{inc/img/microfacet}
  \caption{Микрогранные модели}
\end{figure}

Модели отражения, основанные на микрофасетках, которые проявляют идеальное 
зеркальное отражение и пропускание, успешно используются для моделирования 
рассеяния света от различных глянцевых материалов, включая металлы, пластик 
и матовое стекло.
Одной из важных характеристик поверхности микрофасетки является функция 
распределения, которая показывает дифференциальную площадь микрофасеток 
с нормалью поверхности. Две самые популярные модели микрограней -- 
основанная на модели Бекерманна, и основанная на модели GGX. Их разница 
заключается в различных радиометрических свойствах, которые неважны
для непрофессионального разработчика трассировщиков. Однако на практике,
модель GGX показывает лучшие результаты при одинаковом количестве вычислений.
~\cite{PBRT3e}~\cite{MMfRtRS}

\section{Вывод}

Было принято решение выполнять разработку для выполнения на графическом сопроцессоре,
поскольку это позволяет выполнять отрисовку значетельно более эффективно, чем на ЦПУ.

В качестве алгоритма трассировки был выбран алгоритм трассировки лучей, поскольку он имеет
лучшие возможности для получния физически-корректных изображений, чем 
алгоритм, использующий $z$-буфер.
Для оптимизации отрисовки был выбран способ кеширования 
обратной репроекции.

В качестве модели освещения была выбрана физически-корректная модель с использованием
микрограней с моделью GGX, поскольку такой вариант предоставляет лучший вариант
получения реалистичных изображений, чем другие модели освещения и модель микрограней Бекерманна~\cite{MMfRtRS}.
